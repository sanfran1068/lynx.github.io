<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>Lynx-Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="Lynx-Blog">
<meta property="og:url" content="http://keefe.wang/index.html">
<meta property="og:site_name" content="Lynx-Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lynx-Blog">
    

    
        <link rel="alternate" href="/" title="Lynx-Blog" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="progress">
        <span></span>
    </div>

    <div id="container">

        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Lynx-Blog</span>
            </a>

            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>

            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>

            <!---->

        </div>
    </div>

    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>

</header>


            

<div class="slideshow-container">
    <div class="mySlides fade">
        <img src="css/images/1.jpg">
    </div>

    <div class="mySlides fade">
        <img src="css/images/2.jpg">
    </div>

    <div class="mySlides fade">
        <img src="css/images/3.jpg">
    </div>

    <a class="carousel-prev" onclick="plusSlides(-1)"><span class="fa fa-chevron-left"></span></a>
    <a class="carousel-next" onclick="plusSlides(1)"><span class="fa fa-chevron-right"></span></a>
</div>

<script>
    var slideIndex = 1;
    showSlides(slideIndex);

    function plusSlides(n) {
        showSlides(slideIndex += n);
    }

    function currentSlide(n) {
        showSlides(slideIndex = n);
    }

    function showSlides(n) {
        var i;
        var slides = document.getElementsByClassName("mySlides");

        if (n > slides.length) {slideIndex = 1}
        if (n < 1) {slideIndex = slides.length}

        for (i = 0; i < slides.length; i++) {
            slides[i].style.display = "none";
        }

        slides[slideIndex-1].style.display = "block";
    }
</script>

<div class="outer">
    <section id="main">
        
            <article id="post-2020-05-30-source-code-reading-Egg-starting" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        <div class="article-corner"></div>
        

        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2020/05/23/2020-05-30-source-code-reading-Egg-starting.html">EggJS源码阅读-启动流程与代码实现</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2020/05/23/2020-05-30-source-code-reading-Egg-starting.html">
            <time datetime="2020-05-23T04:30:00.000Z" itemprop="datePublished">2020-05-23</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/SourceCodeReading/">SourceCodeReading</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/EggJS/">EggJS</a>, <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>, <a class="tag-link" href="/tags/NodeJS/">NodeJS</a>, <a class="tag-link" href="/tags/源码学习/">源码学习</a>
    </div>

                    </div>
                
            </header>
        

        

        <div class="article-entry" itemprop="articleBody">

        
            
            <blockquote>
<p>egg是阿里开源的一个框架，为企业级框架和应用而生，相较于express和koa，有更加严格的目录结构和规范。不同的团队可以基于egg，根据自己的需求封装出适合团队业务的更上层框架。</p>
</blockquote>
<h3 id="egg如何启动"><a href="#egg如何启动" class="headerlink" title="egg如何启动"></a>egg如何启动</h3><p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiZDc4MmQxN2MtM2FjYS00MDZhLTk4MDktOGRmMzMwY2M3ZGQxIiwicmVzb3VyY0d1aWQiOiJiMzZlODM2OS0xNzY1LTQzOTEtOTAzOC0zN2Q0NmE0NWVjNjAifQ==" alt="fca8379caeffb9c194aa5369db1c563b.png"></p>
<p>根据<code>package.json</code>中的<code>script</code>命令，可以看到执行的直接是<code>egg-bin dev</code>的命令。找到<code>egg-bin</code>文件夹中的<code>dev.js</code>,会看到里面会去执行外层的<code>start-cluster</code>文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">require(options.framework).startCluster(options);</div></pre></td></tr></table></figure>
<p>此处的<code>options.framework</code>其实指的就是<code>egg</code>框架，然后调用了<code>egg-cluster</code>包中的<code>startCluster</code>方法，egg正式迈出了启动的第一步。</p>
<p>[源码流程]</p>
<p><code>egg</code>框架采用了<code>master-agent-worder</code>的集群模式，如果所示，官方文档中也对于这三种进程的启动和通信给出了较为详细的说明：</p>
<ul>
<li>Master 启动后先 fork Agent 进程</li>
<li>Agent 初始化成功后，通过 IPC 通道通知 Master</li>
<li>Master 再 fork 多个 App Worker</li>
<li>App Worker 初始化成功，通知 Master</li>
<li>所有的进程初始化成功后，Master 通知 Agent 和 Worker 应用启动成功</li>
</ul>
<p>我们尝试从源码中大致将这个流程实现出来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// egg-cluster/lib/master.js</span></div><div class="line">ready.mixin(<span class="keyword">this</span>);              <span class="comment">// 将 ready 方法挂在 Master 上</span></div><div class="line"><span class="keyword">this</span>.detectPorts().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;  <span class="comment">// 检测端口</span></div><div class="line">    <span class="keyword">this</span>.forkAgentWorker();      <span class="comment">// 启动 agent 进程，发送 agent-start 消息给 master 进程</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// master 进程一旦接收到 agent-start 消息后，开始创建 worker 进程</span></div><div class="line"><span class="keyword">this</span>.once(<span class="string">'agent-start'</span>, <span class="keyword">this</span>.forkAppWorkers.bind(<span class="keyword">this</span>));</div></pre></td></tr></table></figure>
<p>[源码流程]</p>
<h3 id="Agent与AppWorker的实现"><a href="#Agent与AppWorker的实现" class="headerlink" title="Agent与AppWorker的实现"></a>Agent与AppWorker的实现</h3><h4 id="AgentWorker与AppWorker进程的启动"><a href="#AgentWorker与AppWorker进程的启动" class="headerlink" title="AgentWorker与AppWorker进程的启动"></a>AgentWorker与AppWorker进程的启动</h4><p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiZDc4MmQxN2MtM2FjYS00MDZhLTk4MDktOGRmMzMwY2M3ZGQxIiwicmVzb3VyY0d1aWQiOiI3ZmViNGFmYS1kMzNlLTQ1MDgtYjAyNi0wYWIyOGRkMDc2Y2MifQ==" alt="de59fd88a438492231f38fb2032ffd5b.png"></p>
<p>在启动<code>AgentWorker</code>和<code>AppWorker</code>时，会分别加载<code>agent_worker.js</code>和<code>app_worker.js</code>两个文件并创建进程，其中<code>agent_worker.js</code>中会创建<code>Agent</code>类的实例，而<code>app_worker.js</code>中会创建<code>Application</code>类的实例。</p>
<p>两种进程在启动时都会调用<code>this.loader.load()</code>方法来加载自己相应的一些插件和自定义的扩展。</p>
<p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiZDc4MmQxN2MtM2FjYS00MDZhLTk4MDktOGRmMzMwY2M3ZGQxIiwicmVzb3VyY0d1aWQiOiI0MDczM2IwZi04OTc0LTQxNzctYjM4Zi0zN2I0MTE3ZGQ2MjAifQ==" alt="18d21732106d0293791bf03d6481784b.png"></p>
<p>基于<code>egg_loader</code>实现了<code>AppWorkerLoader</code>和 <code>AgentWorkerLoader</code>，上层框架基于这两个类来扩展，<code>Loader</code>的扩展只能在框架进行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; AppWorkerLoader &#125; <span class="keyword">from</span> <span class="string">'egg'</span></div><div class="line"><span class="keyword">import</span> common <span class="keyword">from</span> <span class="string">'./common'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAppWorkerLoader</span> <span class="keyword">extends</span> <span class="title">AppWorkerLoader</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(opt) &#123;</div><div class="line">    <span class="keyword">super</span>(opt);</div><div class="line">        <span class="comment">// 自定义初始化</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    loadConfig() &#123;</div><div class="line">        <span class="keyword">super</span>.loadConfig();</div><div class="line">        <span class="comment">// 对 config 进行处理</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    load() &#123;</div><div class="line">        <span class="keyword">super</span>.load();</div><div class="line">        <span class="comment">// 自定义加载其他目录</span></div><div class="line">        <span class="comment">// 或对已加载的文件进行处理</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="built_in">Object</span>.assign(MyAppWorkerLoader.prototype, &#123;</div><div class="line">    <span class="comment">// 可以根据自己的需求，重写一些获取配置的方法</span></div><div class="line">    getServerEnv()&#123;&#125;;</div><div class="line">    _preloadAppConfig()&#123;&#125;</div><div class="line">    getTypeFiles()&#123;&#125;</div><div class="line">&#125;)</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> MyAppWorkerLoader</div></pre></td></tr></table></figure>
<h4 id="Agent如何实现"><a href="#Agent如何实现" class="headerlink" title="Agent如何实现"></a>Agent如何实现</h4><p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiZDc4MmQxN2MtM2FjYS00MDZhLTk4MDktOGRmMzMwY2M3ZGQxIiwicmVzb3VyY0d1aWQiOiJmMTAwMWJlZi05OWMwLTQ3Y2MtYjk3NS1kYmZiNjI1N2VkNjMifQ==" alt="f2ac3732452f487f21e11c0de480f3df.png"></p>
<p><code>Agent</code>对象在<code>egg-cluster</code>创建环节中被创建出来，继承自<code>egg.Agent</code>对象，该对象继承<code>EggApplication</code>,且<code>loader</code>为<code>./lib/loader/agent_worker_loader.js</code>文件，继承自<code>egg-core.eggLoader</code>对象，整体继承链如上图。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// egg/lib/agent.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Agent</span> <span class="keyword">extends</span> <span class="title">EggApplication</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(options = &#123;&#125;) &#123;</div><div class="line">    options.type = <span class="string">'agent'</span>;</div><div class="line">    <span class="comment">// 1.完成父类构建</span></div><div class="line">    <span class="keyword">super</span>(options);</div><div class="line">    <span class="comment">// 2.驱动loader执行load方法</span></div><div class="line">    <span class="keyword">this</span>.loader.load();</div><div class="line">    <span class="comment">// 3.dump相关配置文件进入./run目录下</span></div><div class="line">    <span class="keyword">this</span>.dumpConfig();</div><div class="line">    </div><div class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;, <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>);</div><div class="line">    <span class="comment">// 4.监听异常事件</span></div><div class="line">    <span class="keyword">this</span>._uncaughtExceptionHandler = <span class="keyword">this</span>._uncaughtExceptionHandler.bind(<span class="keyword">this</span>);</div><div class="line">    process.on(<span class="string">'uncaughtException'</span>, <span class="keyword">this</span>._uncaughtExceptionHandler);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Agent</code>类的实现中，主要是实例化了<code>EggApplication</code>，调用了<code>this.loader.load()</code>方法来加载各种文件和配置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// egg/lib/egg.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EggApplication</span> <span class="keyword">extends</span> <span class="title">EggCore</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(options = &#123;&#125;) &#123;</div><div class="line">        options.mode = options.mode || <span class="string">'cluster'</span>;</div><div class="line">        <span class="comment">// 1.原型EggCore构建</span></div><div class="line">        <span class="keyword">super</span>(options);</div><div class="line">        <span class="comment">// 2.调用loadConfig，在agent的实现中，指向的并不是egg-core.loader，而是agent_worker_loader</span></div><div class="line">        <span class="keyword">this</span>.loader.loadConfig();</div><div class="line">        <span class="comment">// 3.ready事件</span></div><div class="line">        <span class="keyword">this</span>.ready(<span class="function"><span class="params">()</span> =&gt;</span> process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">          <span class="keyword">const</span> dumpStartTime = <span class="built_in">Date</span>.now();</div><div class="line">          <span class="keyword">this</span>.dumpConfig();</div><div class="line">          <span class="keyword">this</span>.dumpTiming();</div><div class="line">        &#125;));</div><div class="line">        <span class="comment">// 监听unhandleRejection事件</span></div><div class="line">        <span class="comment">// 4.cluster初始化</span></div><div class="line">        <span class="keyword">this</span>[CLUSTER_CLIENTS] = [];</div><div class="line">        <span class="keyword">this</span>.cluster = <span class="function">(<span class="params">clientClass, options</span>) =&gt;</span> &#123;&#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在<code>EggApplication</code>类的实现中，我们可以看到是继承自<code>EggCore</code>类，在父类构建好之后，会调用<code>this.loader.loadConfig()</code>方法，该方法的<code>loader</code>实例实际指向了<code>AgentWorkerLoader（agent_worker_loader.js）</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// egg/lib/loader/agent_worker_loader.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AgentWorkerLoader</span> <span class="keyword">extends</span> <span class="title">EggLoader</span> </span>&#123;</div><div class="line">  loadConfig() &#123;</div><div class="line">    <span class="keyword">this</span>.loadPlugin();  <span class="comment">// loadPlugin from egg-core/lib/loader/mixin/plgin.js</span></div><div class="line">    <span class="keyword">super</span>.loadConfig(); <span class="comment">// loadConfig from egg-core/lib/loader/mixin/config.js</span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  load() &#123;</div><div class="line">    <span class="keyword">this</span>.loadAgentExtend();</div><div class="line">    <span class="keyword">this</span>.loadContextExtend();</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.loadCustomAgent();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>loadPlugin</code>方法会加载三种插件：</p>
<ul>
<li><code>eggPlugins</code>，从eggjs框架配置的插件，也就是<code>egg/config/plugins.js</code>文件中egg框架自带的插件；</li>
<li><code>appPlugins</code>，每个应用自己配置的插件，也就是<code>myproject/config/plugins.js</code>，用户可以自定义配置一些特殊的插件；</li>
<li><code>customPlugins</code>，应用启动命令中参数EGG_PLUGINS值所代表的插件；</li>
</ul>
<p>最后会将这三种插件都挂在app实例上：<code>this.plugins = enablePlugins</code>;</p>
<p><code>loadConfig</code>方法会加载三种配置：</p>
<ul>
<li><code>appConfig</code>，每个应用自己独有的配置，其中会按顺序加载两个配置，一个是默认配置<code>config.default</code>，另一个是当前环境的配置<code>config.${this.serverEnv}</code>，也就是<code>myproject/config</code>下的一些配置文件加载</li>
<li>加载自定义添加的<code>plugin</code>插件的配置</li>
<li>加载框架<code>egg</code>的配置，即<code>egg/config</code></li>
<li>重新加载应用<code>app</code>的配置，即<code>myproject/config</code>下的</li>
</ul>
<p>最后将合并的配置挂载在<code>app</code>实例上<code>this.config = target</code>;</p>
<h4 id="Application如何实现"><a href="#Application如何实现" class="headerlink" title="Application如何实现"></a>Application如何实现</h4><p>上面提到，<code>AppWorker</code>在实例化的过程中，会调用<code>this.loader.load()</code>。进入具体这个<code>Application</code>所对应的<code>loader.load</code>方法，可以发现<code>Application</code>的实现比<code>Agent</code>的实现多调用了很多加载的方法：</p>
<ul>
<li><code>this.loadApplicationExtend();</code>，该方法的调用会给应用加载扩展方法，加载路径为<code>app\extend\application.js</code>, 会将对应的对象挂载在app 应用上。</li>
<li><code>this.loadRequestExtend();</code>，加载<code>app\extend\request.js</code></li>
<li><code>this.loadResponseExtend();</code>，加载<code>app\extend\response.js</code></li>
<li><code>this.loadContextExtend();</code>，加载<code>app\extend\context.js</code></li>
<li><code>this.loadHelperExtend();</code>，加载<code>app\extend\helper.js</code></li>
<li><code>this.loadService()</code></li>
<li><code>this.loadMiddleware()</code></li>
<li><code>this.loadController()</code></li>
<li><code>this.loadRouter()</code></li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li><p>egg启动服务集群，采用了<code>master-agent-worker</code>模式，<code>AgentWorker</code>和<code>AppWorker</code>都由Application(egg/lib/applicaton.js) -&gt; EggApplication(egg/lib/egg.js) -&gt; EggCore(egg-core/lib/egg.js) -&gt; KoaApplication(koa)原型链进行继承</p>
</li>
<li><p><code>Agent</code>和<code>Application</code>在实例化的过程中，都会调用相应的Loader去加载自己所需的插件和配置，且加载顺序严格按照<strong>插件plugin-框架framework-应用application</strong>这样一个顺序</p>
</li>
</ol>
<p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiZDc4MmQxN2MtM2FjYS00MDZhLTk4MDktOGRmMzMwY2M3ZGQxIiwicmVzb3VyY0d1aWQiOiIwZGM3ZmY3Mi1iZjM1LTQzZDMtODE1Ni0wMDk2YmQyY2FiMDUifQ==" alt="0464781205f05b89c1b8807280114dd8.png"></p>

        
        </div>

        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://keefe.wang/2020/05/23/2020-05-30-source-code-reading-Egg-starting.html" data-id="ckgiv6ksa001p2b6qti9n9soq" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    
</article>

        
            <article id="post-2020-03-05-source-code-reading-express-router" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        <div class="article-corner"></div>
        

        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2020/03/15/2020-03-05-source-code-reading-express-router.html">Express源码阅读-router相关</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2020/03/15/2020-03-05-source-code-reading-express-router.html">
            <time datetime="2020-03-15T04:30:00.000Z" itemprop="datePublished">2020-03-15</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/SourceCodeReading/">SourceCodeReading</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Express/">Express</a>, <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>, <a class="tag-link" href="/tags/NodeJS/">NodeJS</a>, <a class="tag-link" href="/tags/源码学习/">源码学习</a>
    </div>

                    </div>
                
            </header>
        

        

        <div class="article-entry" itemprop="articleBody">

        
            
            <p>Express 是一种保持最低程度规模的灵活 Node.js Web 应用程序框架，为 Web 和移动应用程序提供一组强大的功能。</p>
<h3 id="Express中的app"><a href="#Express中的app" class="headerlink" title="Express中的app"></a>Express中的app</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// express.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createApplication</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// typeof app === 'function'，同时它身上还绑定着无数属性和方法</span></div><div class="line">    <span class="keyword">var</span> app = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">        app.handle(req, res, next);</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">// app同时继承了事件监听/触发机制和application.js中的各种方法</span></div><div class="line">    mixin(app, EventEmitter.prototype, <span class="literal">false</span>);</div><div class="line">    mixin(app, proto, <span class="literal">false</span>);</div><div class="line">    <span class="comment">// 此处暴露了request和response两个类</span></div><div class="line">    app.request = <span class="built_in">Object</span>.create(req, &#123; ... &#125;);</div><div class="line">    app.response = <span class="built_in">Object</span>.create(res, &#123; ... &#125;);</div><div class="line">    <span class="comment">// 调用application.js中的init方法，主要调用的是defaultConfiguration方法</span></div><div class="line">    app.init();</div><div class="line">    <span class="keyword">return</span> app;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 这里需要注意的是exports和module.exports的不同：当module.exports被赋值后，exports就不同于module.exports了，所以需要这么做；当然也可以只用module.exports；</span></div><div class="line">exports = <span class="built_in">module</span>.exports = createApplication;</div></pre></td></tr></table></figure>
<p>可以看出，调用express()返回的app其实是一个函数，调用app.listen()其实执行的是http.createServer(app).listen()。因此，app其实就是一个请求处理函数，作为http.createServer的参数。而express其实是一个工厂函数，用来生成请求处理函数。</p>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><blockquote>
<p>An Express application is essentially a series of middleware calls.<br>一个Express应用实际上就是一系列中间件的调用。</p>
</blockquote>
<p>中间件大致可分为两种，一种是普通中间件，通过 <code>app.use(&#39;/user&#39;)</code> 方法进行注册，该方法中的路径是匹配所有以 <code>/user</code> 开头的路径；另外一种是路由中间件，通过 <code>app.METHOD()</code> 方法进行注册，这种方式精确匹配路径，且只能处理确定请求方法的请求。</p>
<p>针对app.use部分的代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">app.use = <span class="function"><span class="keyword">function</span> <span class="title">use</span>(<span class="params">fn</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> offset = <span class="number">0</span>;</div><div class="line">  <span class="comment">// 默认设置路径为根路径，同时判断中间件是方法还是方法所在路径</span></div><div class="line">  <span class="keyword">var</span> path = <span class="string">'/'</span>;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="keyword">var</span> arg = fn;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">Array</span>.isArray(arg) &amp;&amp; arg.length !== <span class="number">0</span>) &#123;</div><div class="line">      arg = arg[<span class="number">0</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> arg !== <span class="string">'function'</span>) &#123;</div><div class="line">      offset = <span class="number">1</span>;</div><div class="line">      path = fn;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// router初始化</span></div><div class="line">  <span class="keyword">this</span>.lazyrouter();</div><div class="line">  <span class="keyword">var</span> router = <span class="keyword">this</span>._router;</div><div class="line">  </div><div class="line">  <span class="keyword">var</span> fns = flatten(slice.call(<span class="built_in">arguments</span>, offset));</div><div class="line">  fns.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">fn</span>) </span>&#123;</div><div class="line">    <span class="comment">// non-express app</span></div><div class="line">    <span class="keyword">if</span> (!fn || !fn.handle || !fn.set) &#123;</div><div class="line">      <span class="keyword">return</span> router.use(path, fn);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    debug(<span class="string">'.use app under %s'</span>, path);</div><div class="line">    fn.mountpath = path;</div><div class="line">    fn.parent = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">    <span class="comment">// restore .app property on req and res</span></div><div class="line">    router.use(path, <span class="function"><span class="keyword">function</span> <span class="title">mounted_app</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">      <span class="keyword">var</span> orig = req.app;</div><div class="line">      fn.handle(req, res, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">        setPrototypeOf(req, orig.request)</div><div class="line">        setPrototypeOf(res, orig.response)</div><div class="line">        next(err);</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">// mounted an app</span></div><div class="line">    fn.emit(<span class="string">'mount'</span>, <span class="keyword">this</span>);</div><div class="line">  &#125;, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>针对app.METHODS的代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">methods.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>)</span>&#123;</div><div class="line">  app[method] = <span class="function"><span class="keyword">function</span>(<span class="params">path</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span> (method === <span class="string">'get'</span> &amp;&amp; <span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</div><div class="line">      <span class="comment">// app.get(setting)</span></div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.set(path);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 路由初始化</span></div><div class="line">    <span class="keyword">this</span>.lazyrouter();</div><div class="line">    <span class="keyword">var</span> route = <span class="keyword">this</span>._router.route(path);</div><div class="line">    route[method].apply(route, slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>));</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="路由详解"><a href="#路由详解" class="headerlink" title="路由详解"></a>路由详解</h3><p>在上面两种中间件的实现代码中，都调用了 <code>this.lazyrouter()</code> 方法，所有涉及到路由的方法都会调用这个方法，作用是初始化一个应用的内部路由。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">app.lazyrouter = <span class="function"><span class="keyword">function</span> <span class="title">lazyrouter</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>._router) &#123;</div><div class="line">    <span class="comment">// 生成一个路由实例</span></div><div class="line">    <span class="keyword">this</span>._router = <span class="keyword">new</span> Router(&#123;</div><div class="line">        caseSensitive: <span class="keyword">this</span>.enabled(<span class="string">'case sensitive routing'</span>),</div><div class="line">        strict: <span class="keyword">this</span>.enabled(<span class="string">'strict routing'</span>)</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">this</span>._router.use(query(<span class="keyword">this</span>.get(<span class="string">'query parser fn'</span>)));</div><div class="line">    <span class="keyword">this</span>._router.use(middleware.init(<span class="keyword">this</span>));</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>针对第一个默认路由，可以看下具体调用了哪些方法，最终实现了什么逻辑：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.get(<span class="string">'query parser fn'</span>);</div><div class="line"><span class="comment">// 上面的 get 方法同 app.get，可以在 methods.forEach 循环处理时，如果 get 方法的入参长度为1时，会调用 this.set(arg)</span></div><div class="line"><span class="comment">// 在set方法中，有针对 'query parser' 的处理</span></div><div class="line"><span class="comment">// 最终，query 方法实现了将 req.query 进行 querystring.parse 的一个解析过程</span></div><div class="line"><span class="keyword">case</span> <span class="string">'query parser'</span>:</div><div class="line">  <span class="keyword">this</span>.set(<span class="string">'query parser fn'</span>, compileQueryParser(val));</div><div class="line">  <span class="keyword">break</span>;</div></pre></td></tr></table></figure></p>
<p>针对第二个默认路由 init，是给 app 上的暴露出的 req、res 继承 node 原生的 request 和 response 的一些属性。</p>
<p>之所以不在 <code>defaultConfiguration</code> 方法中进行这一步路由的初始化，原因在于设置路由的相关参数需要调用app.set方法，这个方法明显需要有app实例，如果在获取app实例的时候就初始化了一个路由，这个路由的参数就没办法配置了。因此，在获取app实例后，必须先对路由参数进行配置，然后再调用对应的app.use等方法。</p>
<h4 id="app-Methods"><a href="#app-Methods" class="headerlink" title="app.Methods"></a>app.Methods</h4><p>我们先以 <code>app.get</code> 为例，通过断点调试的方式来查看 <code>app.get</code> 这种路由的 <code>_router</code> 对象是什么结构。</p>
<p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiZmI2ODUxODEtZjg1Yi00MTc3LTg5MTUtMTMxYTY5OTU2NWU2IiwicmVzb3VyY0d1aWQiOiIzMzk0MTlkZi05NDNlLTQzNzAtOTc0YS1mYjI5NmU3MzQxMDgifQ==" alt="702ca38d0160d8b82ab5d1b7a552bec1.png"></p>
<p>上面的截图是当我们初始化一个 express 实例，并设置了一个 <code>app.get()</code> 的路由后，在 app.listen 处添加断点进行调试时的 app 实例的属性。可以看到在 <code>app._router</code> 中有一个 stack，里面按顺存放着三个 layer 对象，分别是初始化时的 query 和 init 两个路由，和第三个则是我们所设置的 get 路由。每一个 layer 中包含路由处理的回调函数 <code>handle</code>，路由对象 <code>route&lt;Route&gt;</code>，该对象中还包含一个存有 Layer 对象的栈（stack)，就和 <code>app._router.stack</code> 相同。</p>
<p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiZmI2ODUxODEtZjg1Yi00MTc3LTg5MTUtMTMxYTY5OTU2NWU2IiwicmVzb3VyY0d1aWQiOiJkOGY5MWM1ZC1lOWRkLTRmNDYtYmJlMC01MGRkNjJjMDUzMTYifQ==" alt="81b68f825db7a3f5bf1ff7d87c09496d.png"></p>
<p>根据上面对于 <code>app.get</code> 这种路由的结构分析，我们可以先猜想它的实现流程：</p>
<ul>
<li><p>首先根据传入的路径封装一个Route对象，再对传入的回调函数封装成Layer对象，接着把这个Layer对象push到Route.stack里面去</p>
</li>
<li><p>再创建一个默认Layer(跟app.use里面Layer的同级)，把步骤一中的Route挂到这个Layer.route属性上面，而这个Layer对象，会被push到app._router.stack里面</p>
</li>
</ul>
<h4 id="app-use"><a href="#app-use" class="headerlink" title="app.use"></a>app.use</h4><p>接下来我们来看 <code>app.use</code> 这种路由又有什么不同。</p>
<p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiZmI2ODUxODEtZjg1Yi00MTc3LTg5MTUtMTMxYTY5OTU2NWU2IiwicmVzb3VyY0d1aWQiOiIyNzA3MmYzNC03ZTY0LTQ0ODUtOTQxNC05M2RkMmVjNTkwMWYifQ==" alt="08bdd22fe221f77141d8af6afb5ac8bc.png"></p>
<p>可以看到，在这种路由中，除了 <code>query</code> 和 <code>init</code> 两个初始化路由的方法外，第三个真正的回调方法被封装成的 <code>Layer</code> 对象中，<code>route</code> 属性的值为 <code>undefined</code>。<br>所以我们可以猜想：在 <code>app.use</code> 这种路由里，传入的参数（路径、回调函数）会被封装成 <code>Layer</code> 对象（其中 <code>route</code> 属性为 <code>undefined</code>），压入 <code>app._router.stack</code> 栈中。</p>
<h4 id="两种路由的源码实现"><a href="#两种路由的源码实现" class="headerlink" title="两种路由的源码实现"></a>两种路由的源码实现</h4><p>接下来我们通过源码来分析我们写的 <code>app.use(&#39;/main&#39;, someFun())</code> 是如何成为一个 layer 对象并压入 <code>app._router</code> 的路由栈中的。</p>
<p><strong>首先来看 <code>app.use</code>：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">app.use = <span class="function"><span class="keyword">function</span> <span class="title">use</span>(<span class="params">fn</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> path = <span class="string">'/'</span>;   <span class="comment">// 设置一个默认的路由方法路径</span></div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="comment">// 设置路由，同样也是由lazyrouter进行路由对象的初始化：this._router = new Router(&#123;&#125;)</span></div><div class="line">  <span class="keyword">this</span>.lazyrouter();</div><div class="line">  <span class="keyword">var</span> router = <span class="keyword">this</span>._router;</div><div class="line"></div><div class="line">  fns.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">fn</span>) </span>&#123;</div><div class="line">    <span class="comment">// router.use是接下来重点要看的方法</span></div><div class="line">    router.use(path, <span class="function"><span class="keyword">function</span> <span class="title">mounted_app</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">      <span class="comment">// ...</span></div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">  &#125;, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>接下来看 Router 对象的 use 方法实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">proto.use = <span class="function"><span class="keyword">function</span> <span class="title">use</span>(<span class="params">fn</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> path = <span class="string">'/'</span>;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="keyword">var</span> callbacks = flatten(slice.call(<span class="built_in">arguments</span>, offset));</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; callbacks.length; i++) &#123;</div><div class="line">    <span class="keyword">var</span> fn = callbacks[i];</div><div class="line">    <span class="comment">// 针对传入路由中的每一个回调方法，都包装成一个 Layer 对象并压入</span></div><div class="line">    <span class="keyword">var</span> layer = <span class="keyword">new</span> Layer(path, &#123;</div><div class="line">      sensitive: <span class="keyword">this</span>.caseSensitive,</div><div class="line">      strict: <span class="literal">false</span>,</div><div class="line">      end: <span class="literal">false</span></div><div class="line">    &#125;, fn);</div><div class="line">    layer.route = <span class="literal">undefined</span>;</div><div class="line">    <span class="keyword">this</span>.stack.push(layer);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>从代码中可以看到，与我们的猜想一致，<code>app.use</code> 这种路由的实现，是将传入的一个个路径或回调方法等参数封装成 <code>Layer</code> 对象压入 <code>_router.stack</code> 栈中。</p>
<p><strong>然后来看 <code>app.get</code> 这种路由的代码实现：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// methods 中包含各种请求类型等，get 就包含在其中</span></div><div class="line">methods.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>)</span>&#123;</div><div class="line">  app[method] = <span class="function"><span class="keyword">function</span>(<span class="params">path</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span> (method === <span class="string">'get'</span> &amp;&amp; <span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</div><div class="line">      <span class="comment">// app.get(setting)</span></div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.set(path);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.lazyrouter();  <span class="comment">// 路由对象 Router 初始化</span></div><div class="line">    <span class="keyword">var</span> route = <span class="keyword">this</span>._router.route(path);</div><div class="line">    route[method].apply(route, slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>));</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面代码中最终返回的是 <code>app</code>，那么这端代码对 <code>app</code> 进行了什么样的操作呢？我们可以将目光聚焦在 <code>route[method].apply()</code> 这行代码上。接下来我们可以看下 <code>route</code> 到底是个什么东西。<code>this._router.route</code> 的代码实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">proto.route = <span class="function"><span class="keyword">function</span> <span class="title">route</span>(<span class="params">path</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> route = <span class="keyword">new</span> Route(path);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> layer = <span class="keyword">new</span> Layer(path, &#123;</div><div class="line">    sensitive: <span class="keyword">this</span>.caseSensitive,</div><div class="line">    strict: <span class="keyword">this</span>.strict,</div><div class="line">    end: <span class="literal">true</span></div><div class="line">  &#125;, route.dispatch.bind(route));</div><div class="line"></div><div class="line">  layer.route = route;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.stack.push(layer);</div><div class="line">  <span class="keyword">return</span> route;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>这里可以看到返回的 <code>route</code> 是一个 <code>Route</code> 对象，在这个对象中将参数封装成了 <code>Layer</code> 对象推入了 <code>app._router.stack</code> 中。</p>
<p>接下来我们看一下 <code>Route</code> 对象中的一些实现代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Route</span>(<span class="params">path</span>) </span>&#123;</div><div class="line">  <span class="comment">// Route对象初始化时添加了一个空数组stack属性</span></div><div class="line">  <span class="keyword">this</span>.path = path;</div><div class="line">  <span class="keyword">this</span>.stack = [];</div><div class="line">  <span class="keyword">this</span>.methods = &#123;&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 对于app.METHODS这种路由，将路由参数（路径、回调方法）包装成Layer对象压入Route.stack中</span></div><div class="line">methods.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>)</span>&#123;</div><div class="line">  Route.prototype[method] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> handles = flatten(slice.call(<span class="built_in">arguments</span>));</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; handles.length; i++) &#123;</div><div class="line">      <span class="comment">// ...</span></div><div class="line">      <span class="keyword">var</span> layer = Layer(<span class="string">'/'</span>, &#123;&#125;, handle);</div><div class="line">      layer.method = method;</div><div class="line"></div><div class="line">      <span class="keyword">this</span>.methods[method] = <span class="literal">true</span>;</div><div class="line">      <span class="keyword">this</span>.stack.push(layer);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>至此，在调用 <code>route[method].apply()</code> 时就会为 <code>app.METHODS</code> 这种类型的路由的 <code>Layer</code> 中添加 <code>route&lt;Route&gt;</code> 属性。</p>
<p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiZmI2ODUxODEtZjg1Yi00MTc3LTg5MTUtMTMxYTY5OTU2NWU2IiwicmVzb3VyY0d1aWQiOiIyYWEwMDk1ZS1jOGQwLTRkNjMtOWUzNi0yNGZmMjY4NjllOTkifQ==" alt="e6778eb14b0b4f77fc6bc60d49e9a053.png"></p>

        
        </div>

        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://keefe.wang/2020/03/15/2020-03-05-source-code-reading-express-router.html" data-id="ckgiv6ks5001i2b6qyjlqi3kq" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    
</article>

        
            <article id="post-2020-01-12-Javascript-module-history" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        <div class="article-corner"></div>
        

        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2020/01/12/2020-01-12-Javascript-module-history.html">JavaScript模块化</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2020/01/12/2020-01-12-Javascript-module-history.html">
            <time datetime="2020-01-12T04:30:00.000Z" itemprop="datePublished">2020-01-12</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Reading/">Reading</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>, <a class="tag-link" href="/tags/规范/">规范</a>, <a class="tag-link" href="/tags/读书笔记/">读书笔记</a>
    </div>

                    </div>
                
            </header>
        

        

        <div class="article-entry" itemprop="articleBody">

        
            
            <h4 id="名词定义先行"><a href="#名词定义先行" class="headerlink" title="名词定义先行"></a>名词定义先行</h4><p>模块化主要解决以下三个问题：</p>
<ul>
<li>代码分离</li>
<li>不同模块间的依赖定义</li>
<li>代码到执行环境的传递</li>
</ul>
<p>能够解决其中一两个点的解决方案我们称之为“<strong>模式</strong>”，能够解决全部三个问题的方案我们称之为“<strong>模块系统</strong>”；</p>
<p>我们将封装好的导出实例（对象、方法等）和引入的实例称为“<strong>模块格式</strong>”；用“分离依赖定义（detached dependency definitions，即用不同文件存储不同文件）”来描述模块系统中可被使用的独立依赖。</p>
<h4 id="关于模块化所解决的问题"><a href="#关于模块化所解决的问题" class="headerlink" title="关于模块化所解决的问题"></a>关于模块化所解决的问题</h4><ul>
<li>命名冲突</li>
</ul>
<p>在1995-1999年间，使用var来定义全局变量是非常方便的，因为当时的JavaScript就是用来编写脚本处理小微任务，而随着应用的代码量上升，全局变量的缺点就越来越明显，因此我们甚至不能引用第三方脚本。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file greeting.js</span></div><div class="line"><span class="keyword">var</span> helloInLang = &#123;</div><div class="line">    en: <span class="string">'Hello world!'</span>,</div><div class="line">    es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">    ru: <span class="string">'Привет мир!'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeHello</span>(<span class="params">lang</span>) </span>&#123;</div><div class="line">    <span class="built_in">document</span>.write(helloInLang[lang]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// file hello.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeHello</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">document</span>.write(<span class="string">'The script is broken'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>支持大量代码仓库</li>
</ul>
<p>由于编写应用的代码量越来越大，我们常常需要将代码分为多个脚本文件逐一引入，这导致了越来越多数量的脚本文件需要我们手动维护，而且还要考虑脚本引入的顺序！这真是太令人头痛！</p>
<h4 id="Directly-Defined-Dependencies"><a href="#Directly-Defined-Dependencies" class="headerlink" title="Directly Defined Dependencies"></a>Directly Defined Dependencies</h4><p>1999年提出的首次对于独立依赖的模式“直接定义依赖”。该模式是由 Erik Arvidsson 在1999年提出。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file greeting.js</span></div><div class="line">dojo.provide(<span class="string">"app.greeting"</span>);</div><div class="line"></div><div class="line">app.greeting.helloInLang = &#123;</div><div class="line">    en: <span class="string">'Hello world!'</span>,</div><div class="line">    es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">    ru: <span class="string">'Привет мир!'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">app.greeting.sayHello = <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> app.greeting.helloInLang[lang];</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// file hello.js</span></div><div class="line">dojo.provide(<span class="string">"app.hello"</span>);</div><div class="line"></div><div class="line">dojo.require(<span class="string">'app.greeting'</span>);</div><div class="line"></div><div class="line">app.hello = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</div><div class="line">    <span class="built_in">document</span>.write(app.greeting.sayHello(<span class="string">'es'</span>));</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>代码使用dojo 1.6编写，其中dojo.provide用来定义模块，获取模块时需要使用dojo.require</p>
<h4 id="命名空间模式"><a href="#命名空间模式" class="headerlink" title="命名空间模式"></a>命名空间模式</h4><p>在JavaScript中，函数是<code>first class citizens</code>，意味着可以被赋给变量，也可以被函数返回。命名空间模式是由 Erik Arvidsson于2002年发明的互联网应用开发工具Bindows开始形成。该模式类似于：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file app.js</span></div><div class="line"><span class="keyword">var</span> app = &#123;&#125;;</div><div class="line"></div><div class="line"><span class="comment">// file greeting.js</span></div><div class="line">app.helloInLang = &#123;</div><div class="line">    en: <span class="string">'Hello world!'</span>,</div><div class="line">    es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">    ru: <span class="string">'Привет мир!'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// file hello.js</span></div><div class="line">app.writeHello = <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</div><div class="line">    <span class="built_in">document</span>.write(app.helloInLang[lang]);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>可见，所有的逻辑和数据都被放在了app对象的属性中，所以不会污染其他全局变量。尽管该模式看似让代码组织有了一定的规律，但是很明显上面的数据和逻辑仍然没有被隔离，我们很轻易就可以修改这些代码。</p>
<h4 id="模块模式"><a href="#模块模式" class="headerlink" title="模块模式"></a>模块模式</h4><p>模块模式的主旨是将数据和逻辑代码放在闭包中并提供一些公用方法作为对外接口对这些资源进行访问<a href="http://www.adequatelygood.com/JavaScript-Module-Pattern-In-Depth.html" target="_blank" rel="external">JavaScript Module Pattern: In-Depth</a>。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> greeting = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = &#123;&#125;;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> helloInLang = &#123;</div><div class="line">        en: <span class="string">'Hello world!'</span>,</div><div class="line">        es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">        ru: <span class="string">'Привет мир!'</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="built_in">module</span>.getHello = <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> helloInLang[lang];</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="built_in">module</span>.writeHello = <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</div><div class="line">        <span class="built_in">document</span>.write(<span class="built_in">module</span>.getHello(lang))</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="built_in">module</span>;</div><div class="line">&#125;());</div></pre></td></tr></table></figure>
<p>这种将数据和逻辑闭包在立即调用方法中的方式在2008年Douglas Crockford发表的《JavaScript the Good Parts》一书中被称作“模块”。</p>
<h4 id="模板定义依赖（Template-Defined-Dependencies"><a href="#模板定义依赖（Template-Defined-Dependencies" class="headerlink" title="模板定义依赖（Template Defined Dependencies)"></a>模板定义依赖（Template Defined Dependencies)</h4><p>当有多个script文件依赖时，我们可以使用一个模板来将这些依赖进行顺序管理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file app.tmp.js</span></div><div class="line"></div><div class="line"><span class="comment">/*borschik:include:../lib/main.js*/</span></div><div class="line"><span class="comment">/*borschik:include:../lib/helloInLang.js*/</span></div><div class="line"><span class="comment">/*borschik:include:../lib/writeHello.js*/</span></div><div class="line"></div><div class="line"><span class="comment">// file main.js</span></div><div class="line"><span class="keyword">var</span> app = &#123;&#125;;</div><div class="line"></div><div class="line"><span class="comment">// file helloInLang.js</span></div><div class="line">app.helloInLang = &#123;</div><div class="line">    en: <span class="string">'Hello world!'</span>,</div><div class="line">    es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">    ru: <span class="string">'Привет мир!'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// file writeHello.js</span></div><div class="line">app.writeHello = <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</div><div class="line">    <span class="built_in">document</span>.write(app.helloInLang[lang]);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="注释定义依赖"><a href="#注释定义依赖" class="headerlink" title="注释定义依赖"></a>注释定义依赖</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file helloInLang.js</span></div><div class="line"><span class="keyword">var</span> helloInLang = &#123;</div><div class="line">    en: <span class="string">'Hello world!'</span>,</div><div class="line">    es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">    ru: <span class="string">'Привет мир!'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// file sayHello.js</span></div><div class="line"></div><div class="line"><span class="comment">/*! lazy require scripts/app/helloInLang.js */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params">lang</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> helloInLang[lang];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// file hello.js</span></div><div class="line"></div><div class="line"><span class="comment">/*! lazy require scripts/app/sayHello.js */</span></div><div class="line"></div><div class="line"><span class="built_in">document</span>.write(sayHello(<span class="string">'en'</span>));</div></pre></td></tr></table></figure>
<p>这种依赖的工作方式是：首先下载这些依赖文件，并进行文件内容解析，解析到有依赖存在的注释时迭代下载、解析……</p>
<h4 id="外部定义依赖"><a href="#外部定义依赖" class="headerlink" title="外部定义依赖"></a>外部定义依赖</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file deps.json</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"files"</span>: &#123;</div><div class="line">        <span class="string">"main.js"</span>: [<span class="string">"sayHello.js"</span>],</div><div class="line">        <span class="string">"sayHello.js"</span>: [<span class="string">"helloInLang.js"</span>],</div><div class="line">        <span class="string">"helloInLang.js"</span>: []</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// file helloInLang.js</span></div><div class="line"><span class="keyword">var</span> helloInLang = &#123;</div><div class="line">    en: <span class="string">'Hello world!'</span>,</div><div class="line">    es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">    ru: <span class="string">'Привет мир!'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// file sayHello.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params">lang</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> helloInLang[lang];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// file main.js</span></div><div class="line"><span class="built_in">console</span>.log(sayHello(<span class="string">'en'</span>));</div></pre></td></tr></table></figure>
<p>deps.json文件就是我们定义所有依赖的外部上下文依赖文件。当运行这个应用时，加载器会获取到这个文件，将这个文件中的依赖按照数组的正确顺序进行读取和加载。lodash就是使用的这种方法进行依赖加载的。</p>
<h4 id="沙箱模式"><a href="#沙箱模式" class="headerlink" title="沙箱模式"></a>沙箱模式</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file sandbox.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Sandbox</span>(<span class="params">callback</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> modules = [];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> Sandbox.modules) &#123;</div><div class="line">        modules.push(i);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; modules.length; i++) &#123;</div><div class="line">        <span class="keyword">this</span>[modules[i]] = Sandbox.modules[modules[i]]();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    callback(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// file greeting.js</span></div><div class="line">Sandbox.modules = Sandbox.modules || &#123;&#125;;</div><div class="line"></div><div class="line">Sandbox.modules.greeting = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> helloInLang = &#123;</div><div class="line">        en: <span class="string">'Hello world!'</span>,</div><div class="line">        es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">        ru: <span class="string">'Привет мир!'</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        sayHello: <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> helloInLang[lang];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// file app.js</span></div><div class="line"><span class="keyword">new</span> Sandbox(<span class="function"><span class="keyword">function</span>(<span class="params">box</span>) </span>&#123;</div><div class="line">    <span class="built_in">document</span>.write(box.greeting.sayHello(<span class="string">'es'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>该模式的关键是使用一个全局的构造函数来代替全局对象，依赖模块可以被定义为这个构造函数的属性。</p>
<h4 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file greeting.js</span></div><div class="line">angular.module(<span class="string">'greeter'</span>, [])</div><div class="line">    .value(<span class="string">'greeting'</span>, &#123;</div><div class="line">        helloInLang: &#123;</div><div class="line">            en: <span class="string">'Hello world!'</span>,</div><div class="line">            es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">            ru: <span class="string">'Привет мир!'</span></div><div class="line">        &#125;,</div><div class="line"></div><div class="line">        sayHello: <span class="function"><span class="keyword">function</span>(<span class="params">lang</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.helloInLang[lang];</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line"><span class="comment">// file app.js</span></div><div class="line">angular.module(<span class="string">'app'</span>, [<span class="string">'greeter'</span>])</div><div class="line">    .controller(<span class="string">'GreetingController'</span>, [<span class="string">'$scope'</span>, <span class="string">'greeting'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope, greeting</span>) </span>&#123;</div><div class="line">        $scope.phrase = greeting.sayHello(<span class="string">'en'</span>);</div><div class="line">    &#125;]);</div></pre></td></tr></table></figure>
<h4 id="CommonJS-Modules"><a href="#CommonJS-Modules" class="headerlink" title="CommonJS Modules"></a>CommonJS Modules</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file greeting.js</span></div><div class="line"><span class="keyword">var</span> helloInLang = &#123;</div><div class="line">    en: <span class="string">'Hello world!'</span>,</div><div class="line">    es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">    ru: <span class="string">'Привет мир!'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> sayHello = <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> helloInLang[lang];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports.sayHello = sayHello;</div><div class="line"></div><div class="line"><span class="comment">// file hello.js</span></div><div class="line"><span class="keyword">var</span> sayHello = <span class="built_in">require</span>(<span class="string">'./lib/greeting'</span>).sayHello;</div><div class="line"><span class="keyword">var</span> phrase = sayHello(<span class="string">'en'</span>);</div><div class="line"><span class="built_in">console</span>.log(phrase);</div></pre></td></tr></table></figure>
<p>CommonJS使用require和module两个标志来表示依赖的引入和导出。</p>
<h4 id="AMD"><a href="#AMD" class="headerlink" title="AMD"></a>AMD</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file lib/greeting.js</span></div><div class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> helloInLang = &#123;</div><div class="line">        en: <span class="string">'Hello world!'</span>,</div><div class="line">        es: <span class="string">'¡Hola mundo!'</span>,</div><div class="line">        ru: <span class="string">'Привет мир!'</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        sayHello: <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> helloInLang[lang];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// file hello.js</span></div><div class="line">define([<span class="string">'./lib/greeting'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">greeting</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> phrase = greeting.sayHello(<span class="string">'en'</span>);</div><div class="line">    <span class="built_in">document</span>.write(phrase);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
        
        </div>

        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://keefe.wang/2020/01/12/2020-01-12-Javascript-module-history.html" data-id="ckgiv6ksc001t2b6qi36vir19" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    
</article>

        
            <article id="post-2020-01-09-how-to-be-a-pragmatic-programmer" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        <div class="article-corner"></div>
        

        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2020/01/09/2020-01-09-how-to-be-a-pragmatic-programmer.html">怎样做一个Pragmatic Programmer</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2020/01/09/2020-01-09-how-to-be-a-pragmatic-programmer.html">
            <time datetime="2020-01-09T04:30:00.000Z" itemprop="datePublished">2020-01-09</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Reading/">Reading</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>, <a class="tag-link" href="/tags/规范/">规范</a>, <a class="tag-link" href="/tags/读书笔记/">读书笔记</a>
    </div>

                    </div>
                
            </header>
        

        

        <div class="article-entry" itemprop="articleBody">

        
            
            <h4 id="What-maks-a-pragmatic-programmer"><a href="#What-maks-a-pragmatic-programmer" class="headerlink" title="What maks a pragmatic programmer"></a>What maks a pragmatic programmer</h4><p>1.Early adopter/faster adapter: 善于学习新的技术并能够尝试将其集成在自己的知识库中;<br>2.Inquisitive：善于提问、保持好奇心；<br>3.Critical thinker：辩证地看待问题而非一味接受前人的话语；<br>4.Realistic：发觉问题的本质，认识问题的难度并能估计解决该问题的时间；<br>5.Jack of all trades：能够转移领域之后快速适应，通过掌握核心基础知识；<br>6.We who cut mere stones must always be envisioning cathedrals.<br>7.持续以上过程</p>
<h4 id="TIPs"><a href="#TIPs" class="headerlink" title="TIPs"></a>TIPs</h4><p>Tip1.在乎你所做的事情<br>Tip2.不断思考所做的事情，不断从big picture进行思考<br>Tip3.提供解决方案而非各种借口<br>Tip4.“不留一扇破窗”，一旦发现问题及时修复<br>Tip5.做项目的催化剂，吸引资源到一个可预见成功的项目中<br>Tip6.时刻牢记“蓝图”<br>Tip7.将产品质量作为需求之一进行考量<br>Tip8.定期对知识进行投资<br>Tip9.批判地看待自己的所见所闻</p>
<h4 id="持续进行知识投资"><a href="#持续进行知识投资" class="headerlink" title="持续进行知识投资"></a>持续进行知识投资</h4><p>1.定期地进行知识投资<br>2.注重知识的多样性<br>3.在2的基础上注意控制风险<br>4.在一个技术还未成熟前进行学习<br>5.时常对知识库进行review</p>
<h5 id="e-g"><a href="#e-g" class="headerlink" title="e.g."></a>e.g.</h5><p>1.一年至少学习一种新的语言<br>2.一个季度看一本技术书籍（甚至一个月、可涉及非技术例如用户等）<br>3.上课<br>4.参与到用户群体中<br>5.在不同环境中进行试验<br>6.跟上潮流：订阅杂志或期刊</p>

        
        </div>

        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://keefe.wang/2020/01/09/2020-01-09-how-to-be-a-pragmatic-programmer.html" data-id="ckgiv6krw001c2b6qazh74gic" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    
</article>

        
            <article id="post-2019-12-21-clean-code-note" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        <div class="article-corner"></div>
        

        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/12/21/2019-12-21-clean-code-note.html">Clean Code规范整理</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/12/21/2019-12-21-clean-code-note.html">
            <time datetime="2019-12-21T03:30:00.000Z" itemprop="datePublished">2019-12-21</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Reading/">Reading</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>, <a class="tag-link" href="/tags/规范/">规范</a>, <a class="tag-link" href="/tags/读书笔记/">读书笔记</a>
    </div>

                    </div>
                
            </header>
        

        

        <div class="article-entry" itemprop="articleBody">

        
            
            <h4 id="变量："><a href="#变量：" class="headerlink" title="变量："></a>变量：</h4><pre><code>1.变量名有意义
2.不使用魔法数字
3.参数用变量而不是数字
4.mapping中的iterator变量命名清楚
5.属性中不要出现类名/对象名
6.方法参数使用默认值检查参数是否为undefined
</code></pre><h4 id="方法："><a href="#方法：" class="headerlink" title="方法："></a>方法：</h4><pre><code>1.使用一到两个形参（或方法复杂、使用对象类型参数、形参的解构赋值）
2.一个方法应该只做一件事！
3.方法名要能自我解释
4.如果出现重复的代码要精练和抽象
5.使用Object.assign给对象赋值
6.（如果方法中出现flag，应当分成两个方法处理）
7.尽量避免方法的副作用（更改全局变量、多个方法写一个文件、公用一个状态等）
8.处理数组、对象时最好处理其复本
9.修改原生对象和方法最好使用class新建
10.尽量使用函数式编程代替命令式编程
11.存在多个判断条件时用方法来包括，避免使用非类型条件
12.避免使用条件语句，使用多态性（class）来代替
13.避免类型判断
</code></pre><h4 id="对象与数据结构"><a href="#对象与数据结构" class="headerlink" title="对象与数据结构"></a>对象与数据结构</h4><pre><code>1.使用class来实现继承
2.使用链式方法调用
3.谨慎使用继承（仅在以下三种情况使用）：
    a.关系为is-a而不是has-a的时候
    b.基类可以被复用时
    c.想通过更改基类来进行全局属性的改变时
</code></pre><h4 id="SOLID原则"><a href="#SOLID原则" class="headerlink" title="SOLID原则"></a>SOLID原则</h4><pre><code>1.SRP（单一职责）：一个类要足够内聚，负责尽量单一的功能，减少类的改动；
2.OCP（开闭原则）：对扩展开放，对修改封闭；
3.LSP（里式替换）：父类特性在子类中要完全继承无变化，即在父类对象被替换为子类对象时无影响；
4.ISP（接口隔离）：不同接口之间需要进行隔离；
5.DIP（依赖倒置）：高层模块不能依赖底层模块，应都依赖于抽象；
</code></pre><h4 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h4><pre><code>1.用Promises，不用回调函数callbacks（用async/await更好）
</code></pre><h4 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h4><pre><code>1.不确定的代码需要try...catch...
2.不要忘了catch里的错误处理、reject里的错误处理
</code></pre><h4 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h4><pre><code>1.驼峰、下划线、大小写都需要保持一致
</code></pre>
        
        </div>

        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://keefe.wang/2019/12/21/2019-12-21-clean-code-note.html" data-id="ckgiv6ks8001l2b6qzsebr2v5" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    
</article>

        
            <article id="post-2019-12-01-Vue-source-code-reading-data-binding" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        <div class="article-corner"></div>
        

        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/12/01/2019-12-01-Vue-source-code-reading-data-binding.html">源码阅读 - Vue的数据响应式原理</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/12/01/2019-12-01-Vue-source-code-reading-data-binding.html">
            <time datetime="2019-12-01T02:00:00.000Z" itemprop="datePublished">2019-12-01</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/SourceCodeReading/">SourceCodeReading</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>, <a class="tag-link" href="/tags/VUE/">VUE</a>, <a class="tag-link" href="/tags/数据响应/">数据响应</a>, <a class="tag-link" href="/tags/源码学习/">源码学习</a>
    </div>

                    </div>
                
            </header>
        

        

        <div class="article-entry" itemprop="articleBody">

        
            
            <h3 id="什么是数据响应式"><a href="#什么是数据响应式" class="headerlink" title="什么是数据响应式"></a>什么是数据响应式</h3><blockquote>
<p>Vue.js 一个核心思想是数据驱动。所谓数据驱动，是指视图是由数据驱动生成的，我们对视图的修改，不会直接操作 DOM，而是通过修改数据。——<a href="https://ustbhuangyi.github.io/vue-analysis/v2/data-driven/" target="_blank" rel="external">《Vue.js技术揭秘》</a></p>
</blockquote>
<p>没有像 Vue 和 React 这些具有数据响应式特性的前端框架之前，我们从服务端提供过的接口获取到数据要渲染在 html 页面上时，抑或是需要获取表单的值进行计算回显到页面上时，都需要建立很多 DOM 事件监听器，并进行许多的 DOM 操作。举个最简单的例子：用户在 html 页面的表单中输入两个加数 a 和 b ，计算得到两个加数之和，并展示到页面上。这时我们需要监听表单中 a 和 b 两个输入框的变化，拿到变化值相加然后通过修改指定 id 或者 class 的选择器对应的 DOM 来修改两数之和。但是当输入表单不止两个时，就会令人捉急。</p>
<p>而 Vue 的数据响应式大大地优化了这一整套的流程。面对大量的 UI 交互和数据更新，数据响应式让我们做到从容不迫——我们需要去了解数据的改变是怎样被触发，更新触发后的数据改变又是怎样反馈到视图。接下来我们通过对部分 Vue 源码的简单分析和学习来深入了解 Vue 中的数据响应式是怎样实现的。</p>
<p>我们将这一部分的代码分析大致分为三部分：让数据变成响应式、依赖收集和派发更新。</p>
<h3 id="数据响应式的中心思想"><a href="#数据响应式的中心思想" class="headerlink" title="数据响应式的中心思想"></a>数据响应式的中心思想</h3><p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiMWVmM2MyOWMtYzg4YS00ZDI0LTllYjMtYTUwMmZhNmMwODM0IiwicmVzb3VyY0d1aWQiOiI2MTI4MTIwZS1kNWUxLTQxZDgtODFkOS1hNTIyNWM1ODM4Y2MifQ==" alt="5de7af21d4c2de951720c006f84b98fc.png"></p>
<p>该原理图源自 Vue 官方教程的<a href="https://cn.vuejs.org/v2/guide/reactivity.html" target="_blank" rel="external">深入响应式原理</a>，这张图向我们展示了 Vue 的数据响应式的中心思想。</p>
<p>我们先来介绍图中的四个模块，<strong>黄色部分</strong>是 Vue 的渲染方法，视图初始化和视图更新时都会调用 <code>vm._render</code> 方法进行重新渲染。渲染时不可避免地会 touch 到每个需要展示到视图上的数据（<strong>紫色部分</strong>），触发这些数据的 get 方法从而收集到本次渲染的所有依赖。收集依赖和更新派发都是基于<strong>蓝色部分</strong>的 Watcher 观察者。而当我们在修改这些收集到依赖的数据时，会触发数据中的 set 属性方法，该方法会修改数据的值并 notify 到依赖到它的观察者，从而触发视图的重新渲染。<strong>绿色部分</strong>是渲染过程中生成的 Virtual DOM Tree，这棵树不仅关系到视图渲染，更是 Vue 优化视图更新过程的基础。</p>
<h3 id="让数据变成响应式"><a href="#让数据变成响应式" class="headerlink" title="让数据变成响应式"></a>让数据变成响应式</h3><p>基本上大家都了解 Vue 的数据响应式原理是由 JS标准内置对象方法 <strong>Object.defineProperty</strong> 来实现的，而这个方法是<strong>不兼容IE8和FF22及以下版本</strong>的浏览器的，所以 Vue 也只能在这些版本之上的浏览器中才能正常使用。这个方法的作用是直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象。那么数据响应式用这个方法为<strong>什么对象</strong>添加或修改了<strong>什么属性</strong>呢？我们从 Vue 的初始化讲起。</p>
<p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiMWVmM2MyOWMtYzg4YS00ZDI0LTllYjMtYTUwMmZhNmMwODM0IiwicmVzb3VyY0d1aWQiOiIzZTI1NmNmOS1iOWQ4LTRlYjQtOWJiMy1iNTI4ZDU3MWZlYmMifQ==" alt="99d9a00af95016a8e9b0b558fd4249ab.png"></p>
<h4 id="Vue-的初始化"><a href="#Vue-的初始化" class="headerlink" title="Vue 的初始化"></a>Vue 的初始化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">this</span>._init(options)</div><div class="line">&#125;</div><div class="line">initMixin(Vue)     </div><div class="line">stateMixin(Vue)     </div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</div></pre></td></tr></table></figure>
<p>在 <a href="https://github.com/DQFE/vue/blob/dev/src/core/index.js#L1" target="_blank" rel="external"><em>src/core/index.js</em></a> 中我们可以看到一个 Vue 被导出，这个Vue是在 <em>src/core/instance/index</em> 中定义的，Vue 是一个方法，参数是options，我们大胆猜想这个 Vue 就是进行 vue 实例化的方法，而 options 就是我们传入的 data、computed、methods 等属性。这个 Vue 方法中主要调用了 _init 方法，这个方法是在 initMixin 方法调用时定义在 Vue 原型上的一个方法，_init 方法中对当前传入的 options 进行了一些处理（主要是判断当前实例化的是否为组件，使用 mergeOptions 方法对 options 进行加工，此处不做赘述），然后又调用了一系列方法进行了生命周期、事件、渲染器的初始化，我们主要来关注 <strong>initState</strong> 这个方法（<a href="https://github.com/DQFE/vue/blob/dev/src/core/instance/state.js#L48" target="_blank" rel="external"><em>src/core/instance/state.js</em></a>）:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initState</span> (<span class="params">vm: Component</span>) </span>&#123;</div><div class="line">    vm._watchers = []</div><div class="line">    <span class="keyword">const</span> opts = vm.$options</div><div class="line">    <span class="keyword">if</span> (opts.props) initProps(vm, opts.props)</div><div class="line">    <span class="keyword">if</span> (opts.methods) initMethods(vm, opts.methods)</div><div class="line">    <span class="comment">// a*</span></div><div class="line">    <span class="keyword">if</span> (opts.data) &#123;</div><div class="line">        initData(vm)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        observe(vm._data = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (opts.computed) initComputed(vm, opts.computed)</div><div class="line">    <span class="keyword">if</span> (opts.watch &amp;&amp; opts.watch !== nativeWatch) &#123;</div><div class="line">        initWatch(vm, opts.watch)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="将-Vue-实例上的-data-响应式化"><a href="#将-Vue-实例上的-data-响应式化" class="headerlink" title="将 Vue 实例上的 data 响应式化"></a>将 Vue 实例上的 data 响应式化</h4><p>上面的方法中对props、methods、data、computed和watch进行了初始化，这些都是Vue实例化方法中传入参数options对象的一些属性，这些属性都需要被<strong>响应式化</strong>。而针对于data的初始化分了两种情况[a<em>]，一种是options中没有data属性的，该方法会给data赋值一个空对象并进行observe（该方法之后我们会详细讲述），如果有data属性，则调用[<em>*initData</em></em>](<a href="https://github.com/DQFE/vue/blob/dev/src/core/instance/state.js#L112)方法进行初始化。我们主要通过对data属性的初始化来分析Vue中的数据响应式原理。" target="_blank" rel="external">https://github.com/DQFE/vue/blob/dev/src/core/instance/state.js#L112)方法进行初始化。我们主要通过对data属性的初始化来分析Vue中的数据响应式原理。</a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span> (<span class="params">vm: Component</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> data = vm.$options.data</div><div class="line">    <span class="comment">// a*</span></div><div class="line">    data = vm._data = <span class="keyword">typeof</span> data === <span class="string">'function'</span></div><div class="line">    ? getData(data, vm)</div><div class="line">    : data || &#123;&#125;</div><div class="line">    <span class="keyword">if</span> (!isPlainObject(data)) &#123;</div><div class="line">        data = &#123;&#125;</div><div class="line">        process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</div><div class="line">          <span class="string">'data functions should return an object:\n'</span> +</div><div class="line">          <span class="string">'https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function'</span>,</div><div class="line">          vm</div><div class="line">        )</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// b*</span></div><div class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(data)</div><div class="line">    <span class="keyword">const</span> props = vm.$options.props</div><div class="line">    <span class="keyword">const</span> methods = vm.$options.methods</div><div class="line">    <span class="keyword">let</span> i = keys.length</div><div class="line">    <span class="keyword">while</span> (i--) &#123;</div><div class="line">        <span class="comment">// c*</span></div><div class="line">        <span class="keyword">const</span> key = keys[i]</div><div class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">          <span class="keyword">if</span> (methods &amp;&amp; hasOwn(methods, key)) &#123;</div><div class="line">            warn(</div><div class="line">              <span class="string">`Method "<span class="subst">$&#123;key&#125;</span>" has already been defined as a data property.`</span>,</div><div class="line">              vm</div><div class="line">            )</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (props &amp;&amp; hasOwn(props, key)) &#123;</div><div class="line">          process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</div><div class="line">            <span class="string">`The data property "<span class="subst">$&#123;key&#125;</span>" is already declared as a prop. `</span> +</div><div class="line">            <span class="string">`Use prop default value instead.`</span>,</div><div class="line">            vm</div><div class="line">          )</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isReserved(key)) &#123;</div><div class="line">          proxy(vm, <span class="string">`_data`</span>, key)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// d*</span></div><div class="line">    observe(data, <span class="literal">true</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>initData 方法对 options 中的 data 进行处理，主要是有<strong>两个目的</strong>:</p>
<ul>
<li>一方面<strong>将 data 代理到 Vue 实例上</strong>，同时检查 data 中是否使用了 Vue 中的保留字、是否与 props、methods 属性中的数据同名</li>
<li>使用 <strong>observe</strong> 方法将data中的属性变成响应式的</li>
</ul>
<p>之前我们提到在调用 initState 方法之前会有对 Vue 实例化传入的 options 参数进行处理的环节（mergeOptions），这个过程会将 data 处理成一个函数（例如我们在 vue 组件中的 data 属性），之后会调用 <code>callHook(vm, &#39;beforeCreate&#39;)</code> 方法来触发 beforeCreate 的生命周期钩子，这个方法的调用可能会对 data 属性进行进一步处理，所以方法一开始会<strong>对 data 统一做处理使其成为一个function</strong>[a*]。</p>
<p>接下来会对 data 中的每一个数据进行遍历[b<em>]，遍历过程将会使用  <code>hasOwn(methods, key)</code>、<code>hasOwn(props, key)</code>、<code>!isReserved(key)</code> 方法对该数据是否占用保留字、是否与 props 和 methods 中的属性重名进行判断，然后调用 proxy 方法将其代理到 Vue 实例上。此处需要注意的是：<em>*如果 data 中的属性与 props、methods 中的属性重名，那么在 Vue 实例上调用这个属性时的优先级顺序是 props &gt; methods &gt; data</em></em>。</p>
<p>最后对每一个 data 中的属性调用 <code>observe</code> 方法，该方法的功能是赋予 data 中的属性可被监测的特性。这个方法和其中使用到的 Observe 类是在<a href="https://github.com/DQFE/vue/blob/dev/src/core/observer/index.js#L37" target="_blank" rel="external"><em>src/core/observer/index.js</em></a>文件中，observe 方法主要是调用<strong>Observer类构造方法</strong>，将每一个 data中的 value 变成可观察、响应式的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">constructor</span> (value: any) &#123;</div><div class="line">    <span class="keyword">this</span>.value = value</div><div class="line">    <span class="keyword">this</span>.dep = <span class="keyword">new</span> Dep()</div><div class="line">    <span class="keyword">this</span>.vmCount = <span class="number">0</span></div><div class="line">    </div><div class="line">    def(value, <span class="string">'__ob__'</span>, <span class="keyword">this</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</div><div class="line">      <span class="comment">//...</span></div><div class="line">      <span class="keyword">this</span>.observeArray(value)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">this</span>.walk(value)</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到该构造函数有以下几个目的：</p>
<ul>
<li>针对当前的数据对象新建一个订阅器；</li>
<li>为每个数据的value都添加一个<strong>ob</strong>属性，该属性不可枚举并指向自身；</li>
<li>针对数组类型的数据进行单独处理（包括赋予其数组的属性和方法，以及 observeArray 进行的数组类型数据的响应式）；</li>
<li>this.walk(value)，遍历对象的 key 调用 defineReactive 方法；</li>
</ul>
<p><code>defineReactive</code>是真正为数据添加 get 和 set 属性方法的方法，它将 data 中的数据定义一个响应式对象，并给该对象设置 get 和 set 属性方法，其中 get 方法是对依赖进行收集， set 方法是当数据改变时通知 Watcher 派发更新。</p>
<h3 id="依赖收集"><a href="#依赖收集" class="headerlink" title="依赖收集"></a>依赖收集</h3><p>依赖收集的原理是：当视图被渲染时，会触发渲染中所使用到的数据的 get 属性方法，通过 get 方法进行依赖收集。</p>
<p>其真实的逻辑我们举例来说明：当前正在渲染组件 ComponentA，会将当前全局唯一的监听器置为这个 Watcher，这个组件中使用到了数据 <code>data () { return { a: b + 1} }</code>，此时触发b的 getter 会将当前的 watcher 添加到b的订阅者列表 subs 中。也就是说如果 ComponentA 依赖 b，则将该组件的渲染 Watcher 作为订阅者加入b的订阅者列表中。</p>
<p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiMWVmM2MyOWMtYzg4YS00ZDI0LTllYjMtYTUwMmZhNmMwODM0IiwicmVzb3VyY0d1aWQiOiJkZjIxMjIzYi0zN2NkLTQyNTgtOTVhYi02NjM4MzNkZjFlZTIifQ==" alt="1e9dfeb2187b782e42b78196a723f860.jpeg"></p>
<p>我们先看下 <a href="https://github.com/DQFE/vue/blob/dev/src/core/observer/index.js#L160" target="_blank" rel="external">get</a> 属性方法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">get: <span class="function"><span class="keyword">function</span> <span class="title">reactiveGetter</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> value = getter ? getter.call(obj) : val</div><div class="line">  <span class="keyword">if</span> (Dep.target) &#123;</div><div class="line">    dep.depend()</div><div class="line">    <span class="keyword">if</span> (childOb) &#123;</div><div class="line">      childOb.dep.depend()</div><div class="line">      <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</div><div class="line">        dependArray(value)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> value</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Dep-订阅器"><a href="#Dep-订阅器" class="headerlink" title="Dep - 订阅器"></a>Dep - 订阅器</h4><p>数据对象中的 get 方法主要使用 depend 方法进行依赖收集，该方法是 Dep 类中的属性方法，继续来看 <a href="https://github.com/DQFE/vue/blob/dev/src/core/observer/dep.js#L13" target="_blank" rel="external">Dep 类</a>是怎样实现的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</div><div class="line">    <span class="comment">// a*</span></div><div class="line">    <span class="keyword">static</span> target: ?Watcher;</div><div class="line">    id: number;</div><div class="line">    subs: <span class="built_in">Array</span>&lt;Watcher&gt;;</div><div class="line">    <span class="keyword">constructor</span> () &#123;</div><div class="line">        <span class="keyword">this</span>.id = uid++</div><div class="line">        <span class="keyword">this</span>.subs = []</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    addSub (sub: Watcher) &#123;</div><div class="line">        <span class="keyword">this</span>.subs.push(sub)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    depend () &#123;</div><div class="line">        <span class="keyword">if</span> (Dep.target) &#123;</div><div class="line">            Dep.target.addDep(<span class="keyword">this</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Dep.target = <span class="literal">null</span></div><div class="line"><span class="keyword">const</span> targetStack = []</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">pushTarget</span> (<span class="params">target: ?Watcher</span>) </span>&#123;</div><div class="line">    targetStack.push(target)</div><div class="line">    Dep.target = target</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">popTarget</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    targetStack.pop()</div><div class="line">    Dep.target = targetStack[targetStack.length - <span class="number">1</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Dep 类中有三个属性：<code>target</code>、<code>id</code> 和 <code>subs</code>，分别表示当前全局唯一的静态数据依赖的监听器 Watcher、该属性的 id 以及订阅这个属性数据的订阅者列表[a*]。另外还提供了将订阅者添加到订阅者列表的 <code>addSub方法</code>、从订阅者列表删除订阅者的 <code>removeSub</code> 方法。</p>
<p><code>Dep.target</code> 是当前全局唯一的订阅者，这是因为同一时间只允许一个订阅者被处理。target 的意思就是指当前正在处理的目标订阅者，而这个订阅者是有一个订阅者栈 <code>targetStack</code>，当某一个组件执行到某个生命周期的 hook 时（例如 mountComponent），会将当前目标订阅者 target 置为这个 watcher，并将其压入 <code>targetStack</code> 栈顶。</p>
<p>接下来是添加当前数据依赖的 <code>depend方法</code>，<code>Dep.target</code> 对象是一个 Watcher 类的实例，调用 Watcher 类的 <a href="https://github.com/DQFE/vue/blob/dev/src/core/observer/watcher.js#L128" target="_blank" rel="external">addDep 方法</a>，我们看下 addDep 方法将当前的依赖 Dep 实例放在了哪里：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">addDep (dep: Dep) &#123;</div><div class="line">    <span class="keyword">const</span> id = dep.id</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.newDepIds.has(id)) &#123;</div><div class="line">        <span class="keyword">this</span>.newDepIds.add(id)</div><div class="line">        <span class="keyword">this</span>.newDeps.push(dep)</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.depIds.has(id)) &#123;</div><div class="line">            dep.addSub(<span class="keyword">this</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们稍后会对 Watcher 类进行分析，目前先来简单看下 addDep 这个属性方法做了什么。可以看到入参是一个 Dep 类实例，这个实例实际上是当前全局唯一的订阅者，newDepIds 是当前数据依赖 dep 的 id 列表，newDeps 是当前数据依赖 dep 列表，depsId 则是上一个 tick 的数据依赖的 id 列表。这个方法主要的逻辑就是调用当前数据依赖 dep 的类方法 <code>addSub</code>，而这个方法在上面Dep 类方法中可以看到，就是将当前全局唯一的 watcher 实例放入这个数据依赖的订阅者列表中。</p>
<h4 id="target-Watcher的产生"><a href="#target-Watcher的产生" class="headerlink" title="target Watcher的产生"></a>target Watcher的产生</h4><p>我们以生命周期中的 <a href="https://github.com/DQFE/vue/blob/dev/src/core/instance/lifecycle.js#L141" target="_blank" rel="external">mountComponent</a> 这一个阶段为例来分析上面提到的Dep.target 这个全局唯一的当前订阅者 Watcher 是怎样产生的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mountComponent</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">    vm: Component, </span></span></div><div class="line"><span class="function"><span class="params">    el: ?Element, hydrating?: boolean</span></span></div><div class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">let</span> updateComponent</div><div class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; config.performance &amp;&amp; mark) &#123; </div><div class="line">        updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="comment">// 首次渲染视图会进入，生成虚拟Node，更新DOM&#125;</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="comment">// 数据更新时会进入，调用渲染函数对视图进行更新</span></div><div class="line">        vm._update(vm._render(), hydrating)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">new</span> Watcher(vm, updateComponent, noop, &#123;</div><div class="line">        before () &#123;</div><div class="line">            <span class="keyword">if</span> (vm._isMounted &amp;&amp; !vm._isDestroyed) &#123;</div><div class="line">                callHook(vm, <span class="string">'beforeUpdate'</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>)</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">return</span> vm</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过mountComponent的代码可以看到在触发了<code>beforeMount</code>生命周期钩子后，紧接着创建了一个用于渲染Watcher实例。我们通过Watcher类的构造函数来看创建<a href="https://github.com/DQFE/vue/blob/dev/src/core/observer/watcher.js#L45" target="_blank" rel="external">Watcher</a>实例时做了哪些工作：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">constructor</span> (</div><div class="line">    vm: Component,              // 当前渲染的组件</div><div class="line">    expOrFn: string | Function,  // 当前Watcher实例的getter属性方法</div><div class="line">    cb: Function,               // 回调函数</div><div class="line">    options?: ?Object,          // 手动传入watch时的option</div><div class="line">    isRenderWatcher?: boolean    // 是否为渲染watcher的标识</div><div class="line">  ) &#123;</div><div class="line">    <span class="keyword">this</span>.vm = vm</div><div class="line">    <span class="keyword">if</span> (isRenderWatcher) &#123;</div><div class="line">        vm._watcher = <span class="keyword">this</span></div><div class="line">    &#125;</div><div class="line">    vm._watchers.push(<span class="keyword">this</span>)</div><div class="line">    <span class="comment">// 此处处理我们传入的watcher参数（在组件内手动新建watch属性）</span></div><div class="line">    <span class="keyword">if</span> (options) &#123;&#125; <span class="keyword">else</span> &#123;&#125;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="comment">// parse expression for getter</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">'function'</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.getter = expOrFn</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">this</span>.getter = parsePath(expOrFn)</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.getter) &#123;</div><div class="line">            <span class="keyword">this</span>.getter = noop</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.value = <span class="keyword">this</span>.lazy ? <span class="literal">undefined</span> : <span class="keyword">this</span>.get()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过 Watcher 类的构造函数传参可以看到 mountComponent 生命周期中创建的 Watcher 是一个渲染 Watcher，将当前的 getter 设置为了 updateComponent 方法（也就是重新渲染视图的方法），最后调用了 get 属性方法，我们接下来看 <a href="https://github.com/DQFE/vue/blob/dev/src/core/observer/watcher.js#L101" target="_blank" rel="external">get 方法</a>做了什么：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">get () &#123;</div><div class="line">    pushTarget(<span class="keyword">this</span>)</div><div class="line">    <span class="keyword">let</span> value</div><div class="line">    <span class="keyword">const</span> vm = <span class="keyword">this</span>.vm</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        value = <span class="keyword">this</span>.getter.call(vm, vm)</div><div class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.user) &#123;</div><div class="line">            handleError(e, vm, <span class="string">`getter for watcher "<span class="subst">$&#123;<span class="keyword">this</span>.expression&#125;</span>"`</span>)</div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="keyword">throw</span> e &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.deep) &#123;</div><div class="line">            traverse(value)</div><div class="line">        &#125;</div><div class="line">        popTarget()</div><div class="line">        <span class="keyword">this</span>.cleanupDeps()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> value</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>get 方法首先调用了在 <code>Dep类</code>文件中定义的全局方法 pushTarget，将 Dep.target 置为当前正在执行的渲染 Watcher，并将这个 watcher 压到了 targetStack。接下来调用 wathcer 的 getter 方法：由于此时的 getter 就是 updateComponent 方法，执行 updateComponent 方法，也就是 <code>vm._update(vm._render(), hydrating)</code> 进行渲染，渲染过程中必然会 touch 到 data 中相关依赖的属性，此时就会触发各个属性中的 get 方法（也就是将当前的渲染 Watcher 添加到所有渲染中使用到的数据的依赖列表 subs 中）。</p>
<p>渲染完之后会将当前的渲染 Watcher 从 targetStack 推出，进行下一个 watcher 的任务。最后会进行<em>依赖的清空</em>，每次数据的变化都会引起视图重新渲染，每一次渲染又会进行依赖收集，又会触发 data 中每个属性的 get 方法，这时会有一种情况发生：<code>&lt;div v-if=&quot;someBool&quot;&gt;&lt;/div&gt;&lt;div v-else&gt;&lt;/div&gt;</code> 第一次当 someBool 为真时，进行渲染，当我们把 someBool 的值 update 为 false 时，这时候属性 a 不会被使用，所以如果不进行依赖清空，会导致不必要的依赖通知。依赖清空主要是对 newDeps 进行更新，通过对比本次收集的依赖和之前的依赖进行对比，把不需要的依赖清除。</p>
<h3 id="派发更新"><a href="#派发更新" class="headerlink" title="派发更新"></a>派发更新</h3><p><img src="evernotecid://954D5E79-AC85-4E89-863E-EB8C8DEE61D9/appyinxiangcom/23187233/ENResource/p11" alt="6ff6878b57427d1b0115d669089d54d3.png"></p>
<p>当我们修改一个存在 data 属性上的值时，会触发数据中的 <a href="https://github.com/DQFE/vue/blob/dev/src/core/observer/index.js#L173" target="_blank" rel="external">set 属性方法</a>，首先会判断并修改该属性数据的值，并触发自身的 dep.notify 方法开始更新派发：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">set: <span class="function"><span class="keyword">function</span> <span class="title">reactiveSetter</span> (<span class="params">newVal</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> value = getter ? getter.call(obj) : val</div><div class="line">  <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">  childOb = !shallow &amp;&amp; observe(newVal)</div><div class="line">  dep.notify()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来让我们进入<a href="https://github.com/DQFE/vue/blob/dev/src/core/observer/dep.js#L37" target="_blank" rel="external"><code>dep.notify</code></a>这个方法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">notify () &#123;</div><div class="line">    <span class="keyword">const</span> subs = <span class="keyword">this</span>.subs.slice()</div><div class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !config.async) &#123;</div><div class="line">        subs.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.id - b.id)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.length; i &lt; l; i++) &#123;</div><div class="line">      subs[i].update()</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>notify 这个方法是每一个数据在响应式化之后自己内部闭包的 dep 实例的方法，还记得之前讲过的 subs 保存着所有订阅该数据的订阅者，所以在 notify 方法中首先对 subs 这个订阅者序列按照其 id 进行了排序。接下来就是调用每一个订阅者 watcher 实例的 <code>update</code> 方法进行更新的派发。update 方法是在 Watcher 类文件中，使用了队列的方式来管理订阅者的更新派发，其中主要调用了 <a href="https://github.com/DQFE/vue/blob/dev/src/core/observer/scheduler.js#L164" target="_blank" rel="external"><code>queueWatcher</code></a> 这个方法来实现该逻辑：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">queueWatcher</span> (<span class="params">watcher: Watcher</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> id = watcher.id</div><div class="line">  <span class="keyword">if</span> (has[id] == <span class="literal">null</span>) &#123;    <span class="comment">// a*</span></div><div class="line">    has[id] = <span class="literal">true</span></div><div class="line">    <span class="keyword">if</span> (!flushing) &#123;        <span class="comment">// b*</span></div><div class="line">      queue.push(watcher)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">let</span> i = queue.length - <span class="number">1</span></div><div class="line">      <span class="keyword">while</span> (i &gt; index &amp;&amp; queue[i].id &gt; watcher.id) &#123;</div><div class="line">        i--</div><div class="line">      &#125;</div><div class="line">      queue.splice(i + <span class="number">1</span>, <span class="number">0</span>, watcher)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!waiting) &#123;         <span class="comment">// c*</span></div><div class="line">      waiting = <span class="literal">true</span></div><div class="line">      <span class="comment">// ...</span></div><div class="line">      nextTick(flushSchedulerQueue)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>进入该方法后，首先使用一个名为 has 的 Map 来保证每一个 watcher 仅推入队列一次[a<em>]。<code>flushing</code> 这个标识符表示目前这个队列是否正在进行更新派发，如果是，那么将这个 id 对应的订阅者进行替换，如果已经路过这个 id，那么就立刻将这个 id 对应的 watcher 放在下一个排入队列[b</em>]。接下来根据<code>waiting</code> 这个标识符来表示当前是否正在对这个队列进行更新派发[c*]，如果没有的话，就可以调用 <a href="https://github.com/DQFE/vue/blob/dev/src/core/observer/scheduler.js#L71" target="_blank" rel="external"><code>nextTick(flushSchedulerQueue)</code></a> 方法进行真正的更新派发了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushSchedulerQueue</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  flushing = <span class="literal">true</span></div><div class="line">  <span class="keyword">let</span> watcher, id</div><div class="line"></div><div class="line">  queue.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.id - b.id)</div><div class="line">  </div><div class="line">  <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; queue.length; index++) &#123;</div><div class="line">    watcher = queue[index]</div><div class="line">    <span class="keyword">if</span> (watcher.before) &#123;</div><div class="line">      watcher.before()</div><div class="line">    &#125;</div><div class="line">    id = watcher.id</div><div class="line">    has[id] = <span class="literal">null</span></div><div class="line">    watcher.run()</div><div class="line">    <span class="comment">// ...</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这个方法首先对队列中的 watcher 按照其 id 进行了排序，排序的主要目的有三：</p>
<ul>
<li>组件的更新由父到子；因为父组件的创建过程是先于子的，所以 watcher 的创建也是先父后子，执行顺序也应该保持先父后子。</li>
<li>用户的自定义 watcher 要优先于渲染 watcher 执行；因为用户自定义 watcher 是在渲染 watcher 之前创建的。</li>
<li>如果一个组件在父组件的 watcher 执行期间被销毁，那么它对应的 watcher 执行都可以被跳过，所以父组件的 watcher 应该先执行。<br>排序结束之后，便对这个队列进行遍历，并执行<code>watcher.run()</code>方法去实现数据更新的通知，run方法的逻辑是：<ul>
<li>新的值与老的值不同时会触发通知；</li>
<li>但是当值是对象或者deep为true时无论如何都会进行通知</li>
</ul>
</li>
</ul>
<p>所以 watcher 有两个功能，一个是将属性的值进行更新，另一个就是可以执行 watch 中的回调函数 handler(newVal, oldVal)，这也是为何我们可以在 watcher 中拿到新旧两个值的原因。</p>
<p>至此，数据的更新派发也通知到了各个组件，便又可以进行视图的更新渲染，收集依赖，派发更新……</p>

        
        </div>

        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://keefe.wang/2019/12/01/2019-12-01-Vue-source-code-reading-data-binding.html" data-id="ckgiv6ks3001f2b6qdo3l7c67" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    
</article>

        
            <article id="post-2018-03-22-what-happend-during-opening-url" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        <div class="article-corner"></div>
        

        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/03/22/2018-03-22-what-happend-during-opening-url.html">从输入URL到页面加载发生了什么之进阶篇</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/03/22/2018-03-22-what-happend-during-opening-url.html">
            <time datetime="2018-03-22T04:00:00.000Z" itemprop="datePublished">2018-03-22</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Reading/">Reading</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/HTTP/">HTTP</a>, <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>, <a class="tag-link" href="/tags/基础知识/">基础知识</a>, <a class="tag-link" href="/tags/读书笔记/">读书笔记</a>
    </div>

                    </div>
                
            </header>
        

        

        <div class="article-entry" itemprop="articleBody">

        
            
            <p>文章来源：<a href="https://segmentfault.com/a/1190000006879700" target="_blank" rel="external">https://segmentfault.com/a/1190000006879700</a><br>文章优点：采用总分总的形式进行撰写，结构和章节明确，发散较广。</p>
<h4 id="文章首先指出整个过程分为六大步骤："><a href="#文章首先指出整个过程分为六大步骤：" class="headerlink" title="文章首先指出整个过程分为六大步骤："></a>文章首先指出整个过程分为六大步骤：</h4><ul>
<li>DNS解析</li>
<li>TCP连接</li>
<li>发送HTTP请求</li>
<li>服务器处理请求并返回HTTP报文</li>
<li>浏览器解析渲染页面</li>
<li>连接结束</li>
</ul>
<h4 id="DNS解析："><a href="#DNS解析：" class="headerlink" title="DNS解析："></a>DNS解析：</h4><p>将网站的【姓名】翻译成【身份证号】，是一个翻译的过程。<br>这个过程是将网址从右到左进行解析和查询的过程。.=&gt;com=&gt;google.com<br>为了查询效率，DNS解析简历起多级缓存（浏览器缓存，系统缓存，路由器缓存，IPS服务器缓存，根域名服务器缓存，顶级域名服务器缓存，主域名服务器缓存）<br>为了均衡地发送和处理请求，DNS进行负载均衡（DNS重定向），CDN也是利用了该技术，根据每台机器负载量、地理位置距离等返回给用户最优的一个IP地址<br>没有使用CDN时请求服务器资源：localDNS-rootDNS-逐级查询到域名授权的DNS记录-使用查询到的ip去请求内容<br>使用了CDN之后：localDNS-rootDNS-逐级查询到域名授权的DNS记录-向DNS服务器请求最优ip地址-使用该ip去CDN节点服务器返回对应的资源</p>
<p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiNmMwYzU1MDItZTBkNy00MmUxLWJmNzctZTZiZmQzN2RhMDI0IiwicmVzb3VyY0d1aWQiOiIwN2JkOWFiOS0zZTYyLTQzNTMtYmQ3YS0yNWE2ZjA4ZDk0MGEifQ==" alt="DNS解析流程图"></p>
<p><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiNmMwYzU1MDItZTBkNy00MmUxLWJmNzctZTZiZmQzN2RhMDI0IiwicmVzb3VyY0d1aWQiOiI1ZWRmZWExMC0xOTAwLTQzMmYtYTUwZS1lYmVkZjI4YzIxY2QifQ==" alt="DNS解析流程图"></p>
<h4 id="TCP连接"><a href="#TCP连接" class="headerlink" title="TCP连接"></a>TCP连接</h4><p>网站请求大部分使用http请求，http协议是使用tcp作为其传输层协议，（应用http、传输tcp、网络ip、数据、物理），http由tcp报文中提取。<br>由于http报文为明文存在一定风险，所以在http报文包裹入tcp报文之前使用ssl对其进行加密。<br>https在原有tcp握手的基础上需要提前进行一个解密握手。https会有时间损耗，需要在安全和性能两者做出权衡。（公钥加密报文，私钥加密公钥）</p>
<h4 id="发送HTTP请求"><a href="#发送HTTP请求" class="headerlink" title="发送HTTP请求"></a>发送HTTP请求</h4><p>请求报文：请求行（请求方法、内容、协议），请求报头（Accept、Content-Type、Cookie、User-Agent）、请求正文（POST/PUT时会有）<br>响应报文：状态码、响应报头、相应报文<br>状态码：<br>1xx：指示信息–表示请求已接收，继续处理。<br>2xx：成功–表示请求已被成功接收、理解、接受。<br>3xx：重定向–要完成请求必须进行更进一步的操作。4xx：客户端错误–请求有语法错误或请求无法实现。5xx：服务器端错误–服务器未能实现合法的请求。</p>
<h4 id="浏览器解析渲染页面"><a href="#浏览器解析渲染页面" class="headerlink" title="浏览器解析渲染页面"></a>浏览器解析渲染页面</h4><p>文档来源：<a href="https://www.html5rocks.com/en/tutorials/internals/howbrowserswork" target="_blank" rel="external">https://www.html5rocks.com/en/tutorials/internals/howbrowserswork</a><br>主要文章：<a href="https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/#The_rendering_engine" target="_blank" rel="external">https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/#The_rendering_engine</a><br>总流程：<br><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiNmMwYzU1MDItZTBkNy00MmUxLWJmNzctZTZiZmQzN2RhMDI0IiwicmVzb3VyY0d1aWQiOiI3Njc1ZTE1ZS1hZjZhLTRlMmItYmZmNC05OTU3ZGIzM2YyNzYifQ==" alt="浏览器解析渲染页面总流程"></p>
<p>没有脚本的流程：<br><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiNmMwYzU1MDItZTBkNy00MmUxLWJmNzctZTZiZmQzN2RhMDI0IiwicmVzb3VyY0d1aWQiOiI4MTNmMmU1Yi05M2I5LTQ5NTItYWIzYy0yZmE1NzA2ZjQ5YmMifQ==" alt="没有脚本的流程"></p>
<p>HTML Parsing: 输出DOM tree<br>HTML不是一种context free grammar，是因为它不同于XML，它允许一些类似标签缺失等的容错<br>分为两部分：tokenize和tree construction<br>Tokenize：状态机实现，初始状态为DATA，遇到&lt;状态改为TAGOPEN，之后遇到第一个a-z的字符状态改为TAGNAME，之后遇到&gt;状态改为DATA，直到&lt;/&gt;，tokenize就commit一个token，<br>Tree Construction：状态机实现。Document Object在token的parser创建时同时创建，每当一个token被commited，constroctor会判断该token跟哪个dom元素相关，新建该token的元素，并添加到开放元素栈（这个栈用于检查标签闭合以及未正常闭合标签）中：<br><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiNmMwYzU1MDItZTBkNy00MmUxLWJmNzctZTZiZmQzN2RhMDI0IiwicmVzb3VyY0d1aWQiOiI1ZWEwYjRlMi03ZTg1LTRjNzAtOGNhMi0yMjc2NGExZWE2NGYifQ==" alt="DOM tree 生成"></p>
<p>css和js的parse过程：<br>Firefox blocks all scripts when there is a style sheet that is still being loaded and parsed.<br>WebKit blocks scripts only when they try to access certain style properties that may be affected by unloaded style sheets.<br>文章的优点：<br>从dom tree的构建的词法分析层面指出一些标签错误以及兼容方式，从语法分析层面指出了类似<table><table></table></table>这种情况应当怎样处理。<br>render tree构建过程中，构建方法对head标签以及display:none的标签不予插入树结构中，而hidden则会存在在结构当中。</p>
<p>Web优化<br>雅虎35条军规：<a href="https://juejin.im/post/5b73ef38f265da281e048e51" target="_blank" rel="external">https://juejin.im/post/5b73ef38f265da281e048e51</a><br><img src="https://app.yinxiang.com/files/common-services/binary-datas/c2VydmljZVR5cGU9MiZzZXJ2aWNlRGF0YT17Im5vdGVHdWlkIjoiNmMwYzU1MDItZTBkNy00MmUxLWJmNzctZTZiZmQzN2RhMDI0IiwicmVzb3VyY0d1aWQiOiJhODJiMjU2NS1kNTFiLTQzYjMtOTZkYS0wNzIwNmE3MTRlYjYifQ==" alt="35条军规"></p>

        
        </div>

        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://keefe.wang/2018/03/22/2018-03-22-what-happend-during-opening-url.html" data-id="ckgiv6krt001a2b6qwcwjpowc" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    
</article>

        
            <article id="post-2017-10-10-The-Good-Part-of-JavaScripts-The-Good-Part" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        <div class="article-corner"></div>
        

        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/10/2017-10-10-The-Good-Part-of-JavaScripts-The-Good-Part.html">JS语言精粹中的精粹</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/10/2017-10-10-The-Good-Part-of-JavaScripts-The-Good-Part.html">
            <time datetime="2017-10-10T04:00:00.000Z" itemprop="datePublished">2017-10-10</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Document/">Document</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>, <a class="tag-link" href="/tags/基础知识/">基础知识</a>, <a class="tag-link" href="/tags/读书笔记/">读书笔记</a>
    </div>

                    </div>
                
            </header>
        

        

        <div class="article-entry" itemprop="articleBody">

        
            <p><p>《JavaScript语言精粹》这本书可谓是JavaScript这门语言的几乎所有知识点的总结，相当于考试之前要画的重点。尽管书中对于各个知识点的介绍比较少，但是知识点覆盖很全，可以进行反复阅读和积累。下面就对这本书中的知识点进行一个整理和总结。</p></p>
            <p class="article-more-link">
                <a href="/2017/10/10/2017-10-10-The-Good-Part-of-JavaScripts-The-Good-Part.html#more">查看更多</a>
            </p>
        
        </div>

        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://keefe.wang/2017/10/10/2017-10-10-The-Good-Part-of-JavaScripts-The-Good-Part.html" data-id="ckgiv6krr00162b6q5gg63zw0" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    
</article>

        
            <article id="post-2017-10-08-shape-grammar-learning-notes" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        <div class="article-corner"></div>
        

        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/08/2017-10-08-shape-grammar-learning-notes.html">形状文法简介</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/08/2017-10-08-shape-grammar-learning-notes.html">
            <time datetime="2017-10-08T04:00:00.000Z" itemprop="datePublished">2017-10-08</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Research/">Research</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/基础知识/">基础知识</a>, <a class="tag-link" href="/tags/形状文法/">形状文法</a>
    </div>

                    </div>
                
            </header>
        

        

        <div class="article-entry" itemprop="articleBody">

        
            <p><p>形状文法（shape grammar）最早由George Stiny和James Gips在1972年提出，是一种用带符号的形状作为基本要素，用语法结构分析和产生新的形状的设计推理方法，是一种以运算规律为主的设计方法。最早运用于绘画、雕塑和建筑设计领域，后被推广到工业设计领域。我的毕设开题之后，是实验室和阿里一起合作的项目中的一个系统实现，其中大量地使用到了形状文法的方法，所以有必要对该研究进行一些了解和知识点的整理。</p></p>
            <p class="article-more-link">
                <a href="/2017/10/08/2017-10-08-shape-grammar-learning-notes.html#more">查看更多</a>
            </p>
        
        </div>

        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://keefe.wang/2017/10/08/2017-10-08-shape-grammar-learning-notes.html" data-id="ckgiv6krq00142b6qak8of2jw" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    
</article>

        
            <article id="post-2017-09-21-babel-document-study" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        <div class="article-corner"></div>
        

        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/21/2017-09-21-babel-document-study.html">Babel的使用方法</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/21/2017-09-21-babel-document-study.html">
            <time datetime="2017-09-21T04:00:00.000Z" itemprop="datePublished">2017-09-21</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Document/">Document</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Babel/">Babel</a>, <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>, <a class="tag-link" href="/tags/基础知识/">基础知识</a>
    </div>

                    </div>
                
            </header>
        

        

        <div class="article-entry" itemprop="articleBody">

        
            <p><p>Babel是一个广泛使用的转码器，可以将ES6代码转为ES5代码，从而在现有环境执行。</p></p>
            <p class="article-more-link">
                <a href="/2017/09/21/2017-09-21-babel-document-study.html#more">查看更多</a>
            </p>
        
        </div>

        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://keefe.wang/2017/09/21/2017-09-21-babel-document-study.html" data-id="ckgiv6krl000y2b6qhw01g962" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    
</article>

        
        <nav id="page-nav">
            <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
        </nav>
    
    </section>

    
    <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <div class="widget-corner"></div>
        <h3 class="widget-title">Recent Posts</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/05/23/2020-05-30-source-code-reading-Egg-starting.html" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/SourceCodeReading/">SourceCodeReading</a></p>
                            <p class="item-title"><a href="/2020/05/23/2020-05-30-source-code-reading-Egg-starting.html" class="title">EggJS源码阅读-启动流程与代码实现</a></p>
                            <p class="item-date"><time datetime="2020-05-23T04:30:00.000Z" itemprop="datePublished">2020-05-23</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/03/15/2020-03-05-source-code-reading-express-router.html" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/SourceCodeReading/">SourceCodeReading</a></p>
                            <p class="item-title"><a href="/2020/03/15/2020-03-05-source-code-reading-express-router.html" class="title">Express源码阅读-router相关</a></p>
                            <p class="item-date"><time datetime="2020-03-15T04:30:00.000Z" itemprop="datePublished">2020-03-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/01/12/2020-01-12-Javascript-module-history.html" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Reading/">Reading</a></p>
                            <p class="item-title"><a href="/2020/01/12/2020-01-12-Javascript-module-history.html" class="title">JavaScript模块化</a></p>
                            <p class="item-date"><time datetime="2020-01-12T04:30:00.000Z" itemprop="datePublished">2020-01-12</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/01/09/2020-01-09-how-to-be-a-pragmatic-programmer.html" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Reading/">Reading</a></p>
                            <p class="item-title"><a href="/2020/01/09/2020-01-09-how-to-be-a-pragmatic-programmer.html" class="title">怎样做一个Pragmatic Programmer</a></p>
                            <p class="item-date"><time datetime="2020-01-09T04:30:00.000Z" itemprop="datePublished">2020-01-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/12/21/2019-12-21-clean-code-note.html" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Reading/">Reading</a></p>
                            <p class="item-title"><a href="/2019/12/21/2019-12-21-clean-code-note.html" class="title">Clean Code规范整理</a></p>
                            <p class="item-date"><time datetime="2019-12-21T03:30:00.000Z" itemprop="datePublished">2019-12-21</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <div class="widget-corner"></div>
        <h3 class="widget-title">Categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Document/">Document</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Reading/">Reading</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Research/">Research</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SourceCodeReading/">SourceCodeReading</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Toolkit/">Toolkit</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <div class="widget-corner"></div>
        <h3 class="widget-title">Archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <div class="widget-corner"></div>
        <h3 class="widget-title">Tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/API/">API</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Babel/">Babel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS3/">CSS3</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EggJS/">EggJS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Express/">Express</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Http/">Http</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JenaAPI/">JenaAPI</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jupyter/">Jupyter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Knowledge-Base/">Knowledge Base</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Leaflet/">Leaflet</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Map/">Map</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/">Markdown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NodeJS/">NodeJS</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/">Nodejs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ontology/">Ontology</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Selector/">Selector</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VUE/">VUE</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/原型/">原型</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/基础知识/">基础知识</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/形状文法/">形状文法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据响应/">数据响应</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/正则表达式/">正则表达式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/源码学习/">源码学习</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/继承/">继承</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/腾讯地图/">腾讯地图</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/规范/">规范</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/解释器/">解释器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/说明书/">说明书</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书笔记/">读书笔记</a><span class="tag-list-count">12</span></li></ul>
        </div>
    </div>

    
        
    
        
    <div class="widget-wrap widget-list">
        <div class="widget-corner"></div>
        <h3 class="widget-title">Links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
    
</div>






        <footer id="footer" class="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2020 Keefe Wang<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/sanfran1068">Keefe</a>
        </div>
    </div>
</footer>
        


    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>